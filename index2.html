<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabela de Preenchimento</title>
    <style>
        table { width: 50%; table-layout: fixed; border: 5px solid DarkSlateGrey; border-radius: 10px; padding: 10px; }
        td { width: 30px; height: 30px; text-align: center; vertical-align: middle; border: 2px solid #f4fff8; cursor: pointer; }
        .disabled { background-color: #ccc; font-size: 24px; font-weight: bold; font-family: Verdana, sans-serif; }
        .user1 { background-color: lightblue; }
        .user2 { background-color: lightgreen; }
        .user3 { background-color: lightyellow; }
        .user4 { background-color: lightcyan; }
        .user5 { background-color: lightcoral; }
        .user6 { background-color: lightseagreen; }
        .user7 { background-color: moccasin; }
        #btn-relatorio, #btn-limpar-todas { display: none; }
    </style>
</head>
<body>
    <h2>Preenchimento da Tabela</h2>
    <label for="usuario">Usuário:</label>
    <select id="usuario">
        <option value="---">Selecione</option>
        <option value="user1">Usuário 1</option>
        <option value="user2">Usuário 2</option>
        <option value="user3">Usuário 3</option>
        <option value="user4">Usuário 4</option>
        <option value="user5">Usuário 5</option>
        <option value="user6">Usuário 6</option>
        <option value="user7">Usuário 7</option>
        <option value="admin">Administrador</option>
    </select>
    <br><br>
    <label for="senha">Senha:</label>
    <input type="password" id="senha">
    <button onclick="verificarLogin()">Entrar</button>
    <br><br>

    <table id="tabela"></table>
    <br>
    <button onclick="limparCelulasUsuario()">Limpar minhas células</button>
    <button id="btn-limpar-todas" onclick="limparTodasCelulas()">Limpar todas as células (Admin)</button>
    <button id="btn-relatorio" onclick="gerarRelatorio()">Gerar Relatório</button>

    <script>
        const senhas = ["familia1", "familia2", "familia3", "familia4", "familia5", "familia6", "familia7", "admin"];
        const usuarios = ["user1", "user2", "user3", "user4", "user5", "user6", "user7", "admin"];
        let usuarioAtual = null;
        let loginAtivo = false;
        let usuarioPreenchidoPorLinha = [];
        let contadoresUsuarios = {};

        async function carregarDadosAPI() {
            const response = await fetch('/api/save-data');
            const data = await response.json();
            usuarioPreenchidoPorLinha = data.usuarioPreenchidoPorLinha || Array(70).fill(null).map(() => new Set());
            contadoresUsuarios = data.contadoresUsuarios || { user1: 0, user2: 0, user3: 0, user4: 0, user5: 0, user6: 0, user7: 0 };
            carregarTabela(data.tabelaDados);
        }

        async function salvarDadosAPI() {
            const dados = {
                tabelaDados: [],
                usuarioPreenchidoPorLinha,
                contadoresUsuarios
            };

            for (let i = 0; i < 70; i++) {
                for (let j = 0; j < 6; j++) {
                    const celula = document.getElementById(`celula-${i}-${j}`);
                    if (celula.innerText) {
                        dados.tabelaDados.push({
                            linha: i,
                            coluna: j,
                            valor: celula.innerText,
                            usuario: [...celula.classList].find(cls => cls.startsWith('user'))
                        });
                    }
                }
            }

            await fetch('/api/save-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });
        }

        function verificarLogin() {
            const senha = document.getElementById('senha').value;
            const usuarioSelecionado = document.getElementById('usuario').value;
            const senhaCorreta = senhas[usuarios.indexOf(usuarioSelecionado)];

            if (senha === senhaCorreta) {
                loginAtivo = true;
                usuarioAtual = usuarioSelecionado;
                alert('Login realizado com sucesso!');
                if (usuarioAtual === "admin") {
                    document.getElementById('btn-relatorio').style.display = "inline";
                    document.getElementById('btn-limpar-todas').style.display = "inline";
                }
            } else {
                alert('Senha incorreta.');
            }
        }

        async function preencherCelula(linha, coluna) {
            if (!loginAtivo) return alert('Por favor, faça login.');
            if (contadoresUsuarios[usuarioAtual] >= 10) return alert('Limite de 10 números atingido.');
            
            const celula = document.getElementById(`celula-${linha}-${coluna}`);
            const valor = prompt('Digite um número entre 1 e 60:');
            celula.innerText = valor;
            contadoresUsuarios[usuarioAtual]++;
            await salvarDadosAPI();
        }

        carregarDadosAPI();
    </script>
</body>
</html>
